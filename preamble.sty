\usepackage{import}
\usepackage{textcomp} % fractions
\usepackage{titlesec}
\usepackage{makecell}
\usepackage{imakeidx} % Must load before hyperref else index isn't linked
\usepackage[acronym,toc]{glossaries}
\usepackage{hyperref}
\usepackage{fontspec}
\usepackage{tocbibind}
\usepackage{blindtext} % TODO: dev dependency, remove once finished
\usepackage{caption}
\usepackage{multicol}
\usepackage{tabularx}
\usepackage{xltabular}
\usepackage[a4paper]{geometry}
\usepackage[table]{xcolor}
\usepackage{enumitem}
\usepackage{siunitx} % For thousand ',' separation with \num
\usepackage{varwidth} % Minipage that shrinks to content

\setmainfont{Open Sans}

\makeindex[intoc]
\makeglossaries

% Alternating row colors
\newcommand{\unclassedblankrowcolor}{\rowcolor{white}}
\newcommand{\unclassedrowcolors}{
    \rowcolors{1}{white}{gray!30}
}

% Formatting for sub-table title
% Argument 1: number of columns for multicolumn
% Argument 2: subtable title
\newcommand{\unclassedsubtabletitle}[2]{
    \unclassedblankrowcolor
    \multicolumn{#1}{l}{
        \Gape[6pt][0pt]{
            \textbf{\textit{#2}}
        }
    }
}

\captionsetup{justification=raggedright,singlelinecheck=false}

% Forces neat ragged-bottom multicols
\setlength{\parskip}{0pt plus0pt minus0pt}

% Un-numbered section titles
\titleformat{\section}{\normalfont\huge\bfseries}{}{0pt}{}[\hrule]
\titleformat{\subsection}{\normalfont\Large\bfseries}{}{0pt}{}
\titleformat{\subsubsection}{\normalfont\normalsize\bfseries}{}{0pt}{}

% Reduce itemize separation (relies on package enumitem)
\setlist[itemize]{nosep}
\setlist[enumerate]{nosep}

% Chapter title formatting (basically reduced space)
\titleformat
{\chapter}
[display]
{\normalfont\bfseries\Huge} % Size here applies to whole chapter heading
{\itshape\huge \chaptertitlename \ \thechapter} % Size here just applies to "Chapter X"
{0pt}
{}
{}

\titlespacing{\chapter}{0pt}{0pt}{0pt}

% Subsection title formatting (reduced space)
\titlespacing{\subsection}{0pt}{5pt}{0pt}

% Statblock definition (this is a big one)
% Parameter 1: Name
% Parameter 2: Level
% Parameter 3: Section 1 (Attributes, left col)
% Parameter 4: Section 1 (Attributes, right col)
% Parameter 5: Section 2 (Basic stats)
% Parameter 6: Section 3 (Defence)
% Parameter 7: Section 4 (Skills)
% Parameter 8: Section 4 (Features)
% Parameter 9: Section 5 (Actions (includes spells))
% Parameter 10: Section 6 (Other (equipment, etc.))
% TODO: figure out how to use 10 parameters
\newcommand{\statblock}[9]
{
    % No first-line indentation in the stat block
    \setlength{\parindent}{0pt}

    % Title / Level
    {\normalfont\huge\bfseries #1}
    \hfill
    \begin{varwidth}{.9\linewidth}
        \raggedleft
        \normalfont\small\bfseries
        \sisetup{
            mode=text,
            group-separator={,},
            reset-text-family=false,
            reset-text-series=false,
            reset-text-shape=false
        }
        Level \num{#2} \\
        \sisetup{
            mode=text,
            group-separator={,},
            reset-text-family=false,
            reset-text-series=false,
            reset-text-shape=false,
            evaluate-expression
        }
        \num{#2 * 60} XP
    \end{varwidth}

    \hrule

    % Attributes
    \begin{minipage}{.45\linewidth}#3\end{minipage}
    \hfill
    \begin{minipage}{.45\linewidth}#4\end{minipage}

    \hrule

    % Basic stats
    #5

    \hrule

    % Defence
    #6

    \hrule

    % Skills and features
    \begin{multicols}{2}
        #7
    \end{multicols}

    #8

    \hrule

    % Actions (includes spells)
    #9

    \hrule

    % Other (equipment, etc.)
    #10

    \hrule
}

% Some notes on why stat blocks are the way they are:
% - With all skills being written out as e.g. Vision (SEN), and most unexpected
%   usages of skills being untrained ones, you should be able to quickly
%   calculate untrained skills by just taking the ATT. This is why only trained
%   or modified skills are listed, and attributes get top-billing (plus
%   attributes look nice)
% - Attributes are in two columns that you set independently so you can always
%   put each attribute in the same place quite easily (makes it easier to
%   read). i.e. physical attributes on the left, mental attributes on the
%   right, and all the special attributes below that across both columns.
% - Went through a bunch of effort to figure out how to format arbitrarily
%   large levels and XP counts. This way if you want to make a statblock for
%   a god and give them a really high level, like 1,000,000,000 or something,
%   you can.
